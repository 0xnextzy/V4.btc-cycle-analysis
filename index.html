<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Cycle Intelligence ‚Ä¢ Professional Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0c1117;
            --panel: rgba(255, 255, 255, 0.04);
            --panel-hover: rgba(255, 255, 255, 0.06);
            --border: rgba(255, 255, 255, 0.08);
            --text: #e6edf3;
            --text-secondary: #9aa4af;
            --text-muted: #6e7681;
            
            --bullish: #22c55e;
            --neutral: #f59e0b;
            --bearish: #ef4444;
            --primary: #3b82f6;
            --highlight: #60a5fa;
            
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        /* TOP STATUS BAR */
        .status-bar {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .status-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 32px;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--highlight));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .brand-text h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-text p {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .status-metrics {
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .status-metric {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .status-value.bullish {
            color: var(--bullish);
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .status-value.bearish {
            color: var(--bearish);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .health-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            border: 1px solid;
            transition: all 0.3s ease;
        }

        .health-pill.excellent {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
            border-color: rgba(34, 197, 94, 0.3);
            color: var(--bullish);
        }

        .health-pill.good {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border-color: rgba(59, 130, 246, 0.3);
            color: var(--primary);
        }

        .health-pill.fair {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--neutral);
        }

        .health-pill.poor {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--bearish);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        /* MAIN CONTAINER */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 32px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }

        /* GLASS CARD */
        .card {
            background: var(--panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            background: var(--panel-hover);
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: -0.01em;
            color: var(--text);
        }

        .card-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            color: var(--primary);
        }

        .span-3 { grid-column: span 3; }
        .span-4 { grid-column: span 4; }
        .span-6 { grid-column: span 6; }
        .span-8 { grid-column: span 8; }
        .span-12 { grid-column: span 12; }

        /* CHART */
        .chart-wrapper {
            position: relative;
            height: 320px;
            margin-top: 20px;
        }

        .chart-wrapper.medium {
            height: 240px;
        }

        .chart-wrapper.small {
            height: 180px;
        }

        /* METRICS GRID */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
        }

        .metric:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text);
            margin-bottom: 6px;
        }

        .metric-sub {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* HEALTH DISPLAY */
        .health-center {
            text-align: center;
            margin-top: 24px;
        }

        .health-score {
            font-size: 72px;
            font-weight: 800;
            letter-spacing: -0.03em;
            margin: 20px 0;
            background: linear-gradient(135deg, var(--bullish), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .health-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* LAYERS */
        .layers {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }

        .layer {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.3s ease;
        }

        .layer:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .layer-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .layer-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .layer-score {
            font-size: 18px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .layer-score.bullish {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: var(--bullish);
        }

        .layer-score.neutral {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: var(--neutral);
        }

        .layer-score.bearish {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: var(--bearish);
        }

        .layer-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 100px;
            overflow: hidden;
        }

        .layer-fill {
            height: 100%;
            border-radius: 100px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
        }

        .layer-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* STRUCTURE */
        .structure-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .structure-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .structure-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .structure-type {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .structure-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .structure-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 6px;
        }

        .structure-badge.strong {
            background: rgba(34, 197, 94, 0.15);
            color: var(--bullish);
        }

        .structure-badge.moderate {
            background: rgba(245, 158, 11, 0.15);
            color: var(--neutral);
        }

        .structure-badge.weak {
            background: rgba(239, 68, 68, 0.15);
            color: var(--bearish);
        }

        /* SIGNALS */
        .signals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .signal {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .signal.active {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
            border-color: var(--bullish);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
            animation: signal-glow 2s ease-in-out infinite;
        }

        @keyframes signal-glow {
            0%, 100% { box-shadow: 0 0 30px rgba(34, 197, 94, 0.2); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.35); }
        }

        .signal.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-color: var(--neutral);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.2);
        }

        .signal-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 12px;
        }

        .signal-icon {
            font-size: 32px;
        }

        .signal-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        .signal-status {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 500;
        }

        /* ALERT BOX */
        .alert {
            padding: 18px 24px;
            border-radius: 14px;
            border: 1px solid;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            backdrop-filter: blur(10px);
        }

        .alert.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-color: rgba(245, 158, 11, 0.3);
        }

        .alert.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
            border-color: rgba(239, 68, 68, 0.3);
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        /* FOOTER */
        .footer {
            background: linear-gradient(to top, rgba(255, 255, 255, 0.04), transparent);
            border-top: 1px solid var(--border);
            padding: 40px 32px;
            margin-top: 60px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
            max-width: 900px;
            margin: 0 auto 16px;
        }

        .footer-legal {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .span-3, .span-4, .span-6, .span-8 {
                grid-column: span 12;
            }
            
            .status-metrics {
                flex-wrap: wrap;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .grid {
                gap: 16px;
            }
            
            .card {
                padding: 20px;
            }
            
            .status-bar {
                padding: 16px 20px;
            }
            
            .status-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .health-score {
                font-size: 56px;
            }
        }

        /* LOADING */
        .loading {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- TOP STATUS BAR -->
    <div class="status-bar">
        <div class="status-content">
            <div class="brand">
                <div class="brand-icon">‚Çø</div>
                <div class="brand-text">
                    <h1>Bitcoin Cycle Intelligence</h1>
                    <p>Professional Market Analytics</p>
                </div>
            </div>
            
            <div class="status-metrics">
                <div class="status-metric">
                    <div class="status-label">BTC Price</div>
                    <div class="status-value" id="topPrice">--</div>
                </div>
                <div class="status-metric">
                    <div class="status-label">24h Change</div>
                    <div class="status-value" id="topChange">--</div>
                </div>
                <div class="status-metric">
                    <div class="status-label">Market Regime</div>
                    <div class="status-value" id="topRegime">--</div>
                </div>
                <div class="health-pill" id="topHealth">
                    <span class="pulse-dot"></span>
                    <span>Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="container">
        
        <!-- ROW 1: PRICE CHART + HEALTH -->
        <div class="grid">
            <div class="card span-8">
                <div class="card-header">
                    <h2 class="card-title">Price Analysis</h2>
                    <span class="card-badge">Real-Time</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="card span-4">
                <div class="card-header">
                    <h2 class="card-title">Market Health</h2>
                </div>
                <div class="health-center">
                    <canvas id="healthGauge" style="max-height: 160px;"></canvas>
                    <div class="health-score" id="healthScore">--</div>
                    <div class="health-label" id="healthLabel">Calculating...</div>
                </div>
                <div id="healthAlert"></div>
            </div>
        </div>

        <!-- ROW 2: METRICS -->
        <div class="grid">
            <div class="card span-12">
                <div class="card-header">
                    <h2 class="card-title">Key Metrics</h2>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Price</div>
                        <div class="metric-value" id="price">--</div>
                        <div class="metric-sub" id="priceChange">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Market Cap</div>
                        <div class="metric-value" id="mcap">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Volume 24h</div>
                        <div class="metric-value" id="volume">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Dominance</div>
                        <div class="metric-value" id="dominance">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Days Since Halving</div>
                        <div class="metric-value" id="daysHalving">--</div>
                        <div class="metric-sub">April 20, 2024</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">From ATH</div>
                        <div class="metric-value" id="fromATH">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3: LAYERS + STRUCTURE -->
        <div class="grid">
            <div class="card span-6">
                <div class="card-header">
                    <h2 class="card-title">Layer 1-7 Analysis</h2>
                    <span class="card-badge">Multi-Factor</span>
                </div>
                <div class="layers" id="layersContainer"></div>
            </div>

            <div class="card span-6">
                <div class="card-header">
                    <h2 class="card-title">Market Structure</h2>
                    <span class="card-badge">Support/Resistance</span>
                </div>
                <div class="structure-list" id="structureList"></div>
            </div>
        </div>

        <!-- ROW 4: SIGNALS -->
        <div class="grid">
            <div class="card span-12">
                <div class="card-header">
                    <h2 class="card-title">Smart Trading Signals</h2>
                </div>
                <div class="signals" id="signalsContainer"></div>
            </div>
        </div>

        <!-- ROW 5: CYCLE + SENTIMENT -->
        <div class="grid">
            <div class="card span-6">
                <div class="card-header">
                    <h2 class="card-title">Cycle Position</h2>
                </div>
                <div class="chart-wrapper small">
                    <canvas id="cycleChart"></canvas>
                </div>
                <div class="metrics" style="margin-top: 20px;">
                    <div class="metric">
                        <div class="metric-label">Position</div>
                        <div class="metric-value" id="cyclePos">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Top Probability</div>
                        <div class="metric-value" id="topProb">--</div>
                    </div>
                </div>
            </div>

            <div class="card span-6">
                <div class="card-header">
                    <h2 class="card-title">Market Sentiment</h2>
                </div>
                <div class="chart-wrapper small">
                    <canvas id="sentimentChart"></canvas>
                </div>
                <div class="metrics" style="margin-top: 20px;">
                    <div class="metric">
                        <div class="metric-label">Fear & Greed</div>
                        <div class="metric-value" id="fearValue">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Status</div>
                        <div class="metric-value" id="fearLabel" style="font-size: 18px;">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 6: INFO -->
        <div class="grid">
            <div class="card span-12">
                <div class="card-header">
                    <h2 class="card-title">Additional Information</h2>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Stablecoin Liquidity</div>
                        <div class="metric-value" id="stablecoin">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">All-Time High</div>
                        <div class="metric-value" id="ath">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Supply</div>
                        <div class="metric-value" id="supply">--</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Last Update</div>
                        <div class="metric-value" id="lastUpdate" style="font-size: 16px;">--</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="footer-text">
            <strong>Educational Disclaimer:</strong> This dashboard provides market data and analysis for educational purposes only. 
            All indicators are probabilistic models. Not financial advice. Cryptocurrency investments carry significant risk.
            Always conduct your own research and consult qualified financial advisors.
        </div>
        <div class="footer-legal">
            Data Sources: CoinGecko ‚Ä¢ Alternative.me ‚Ä¢ Multi-Layer Analysis Engine<br>
            ¬© 2024 Bitcoin Cycle Intelligence ‚Ä¢ Real-time updates every 60 seconds
        </div>
    </footer>

    <script>
        const CONFIG = {
            HALVING_DATE: new Date('2024-04-20'),
            GENESIS_DATE: new Date('2009-01-03'),
            UPDATE_INTERVAL: 60000,
            FETCH_TIMEOUT: 8000,
            API: {
                bitcoin: 'https://api.coingecko.com/api/v3/coins/bitcoin',
                global: 'https://api.coingecko.com/api/v3/global',
                usdt: 'https://api.coingecko.com/api/v3/coins/tether',
                usdc: 'https://api.coingecko.com/api/v3/coins/usd-coin',
                fearGreed: 'https://api.alternative.me/fng/'
            }
        };

        let charts = {};

        function safe(num, fallback = 0) {
            return isFinite(num) && !isNaN(num) ? num : fallback;
        }

        function fmt(num, decimals = 0) {
            if (!isFinite(num)) return '--';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function fmtLarge(num) {
            if (!isFinite(num)) return '--';
            const abs = Math.abs(num);
            if (abs >= 1e12) return `$${(num/1e12).toFixed(2)}T`;
            if (abs >= 1e9) return `$${(num/1e9).toFixed(2)}B`;
            if (abs >= 1e6) return `$${(num/1e6).toFixed(2)}M`;
            return `$${fmt(num, 0)}`;
        }

        function fmtPercent(num) {
            if (!isFinite(num)) return '--';
            return `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;
        }

        async function fetchJSON(url) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), CONFIG.FETCH_TIMEOUT);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeout);
                if (!response.ok) throw new Error('HTTP error');
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        function getDays(date) {
            return Math.floor((Date.now() - date) / (1000 * 60 * 60 * 24));
        }

        const LayerSystem = {
            scorePriceTrend(price, ema50, ema200) {
                let score = 50;
                if (price > ema200) score += 25;
                if (price > ema50) score += 15;
                if (ema50 > ema200) score += 10;
                return safe(score, 50);
            },

            scoreMomentum(change24h) {
                let score = 50;
                if (change24h > 5) score = 85;
                else if (change24h > 2) score = 70;
                else if (change24h > 0) score = 60;
                else if (change24h > -2) score = 40;
                else if (change24h > -5) score = 30;
                else score = 15;
                return safe(score, 50);
            },

            scoreVolatility(change24h) {
                const vol = Math.abs(change24h);
                let score = 50;
                if (vol < 2) score = 70;
                else if (vol < 5) score = 50;
                else if (vol < 10) score = 30;
                else score = 20;
                return safe(score, 50);
            },

            scoreLiquidity(stablecoinCap, btcDom) {
                let score = 50;
                if (stablecoinCap > 140e9) score += 20;
                else if (stablecoinCap > 120e9) score += 10;
                if (btcDom > 50) score += 15;
                else if (btcDom > 45) score += 5;
                return safe(Math.min(100, score), 50);
            },

            scoreSentiment(fearGreed) {
                let score = 50;
                if (fearGreed < 25) score = 80;
                else if (fearGreed < 40) score = 70;
                else if (fearGreed < 55) score = 50;
                else if (fearGreed < 70) score = 40;
                else if (fearGreed < 85) score = 25;
                else score = 10;
                return safe(score, 50);
            },

            scoreStructure(price, ath, cyclePos) {
                let score = 50;
                const pctFromATH = ((price - ath) / ath) * 100;
                if (pctFromATH > -10) score = 30;
                else if (pctFromATH > -30) score = 50;
                else if (pctFromATH > -50) score = 70;
                else score = 85;
                
                if (cyclePos < 0.3) score = Math.min(100, score + 15);
                return safe(score, 50);
            },

            scoreCyclePosition(cyclePos, daysHalving) {
                let score = 50;
                if (cyclePos < 0.2) score = 85;
                else if (cyclePos < 0.4) score = 70;
                else if (cyclePos < 0.6) score = 50;
                else if (cyclePos < 0.8) score = 30;
                else score = 15;
                
                if (daysHalving < 180) score = Math.min(100, score + 10);
                else if (daysHalving > 550) score = Math.max(0, score - 10);
                
                return safe(score, 50);
            },

            calculateAll(data) {
                const ema50 = data.price * 0.98;
                const ema200 = data.price * 0.95;
                
                return {
                    layer1: this.scorePriceTrend(data.price, ema50, ema200),
                    layer2: this.scoreMomentum(data.change24h),
                    layer3: this.scoreVolatility(data.change24h),
                    layer4: this.scoreLiquidity(data.stablecoin, data.dominance),
                    layer5: this.scoreSentiment(data.fearGreed),
                    layer6: this.scoreStructure(data.price, data.ath, data.cyclePos),
                    layer7: this.scoreCyclePosition(data.cyclePos, data.daysHalving)
                };
            },

            calculateMarketHealth(layers) {
                const weights = [0.20, 0.15, 0.10, 0.15, 0.10, 0.15, 0.15];
                const values = [layers.layer1, layers.layer2, layers.layer3, layers.layer4,
                               layers.layer5, layers.layer6, layers.layer7];
                const score = values.reduce((sum, val, i) => sum + val * weights[i], 0);
                return Math.round(safe(score, 50));
            }
        };

        const MarketStructure = {
            detectStructure(price, ath, cyclePos) {
                const structure = [];
                
                structure.push({
                    type: 'Resistance',
                    price: ath,
                    strength: 'Strong'
                });
                
                const roundLevel = Math.floor(price / 10000) * 10000;
                if (price < roundLevel + 5000) {
                    structure.push({
                        type: 'Support',
                        price: roundLevel,
                        strength: 'Moderate'
                    });
                }
                
                const genesis = getDays(CONFIG.GENESIS_DATE);
                const support = 0.0000001 * Math.pow(genesis, 5.8);
                structure.push({
                    type: 'Support',
                    price: support,
                    strength: 'Strong'
                });
                
                structure.push({
                    type: 'Support',
                    price: price * 0.85,
                    strength: 'Weak'
                });
                
                structure.push({
                    type: 'Resistance',
                    price: price * 1.15,
                    strength: 'Moderate'
                });
                
                return structure.sort((a, b) => b.price - a.price);
            }
        };

        const SmartSignals = {
            evaluate(data, layers, health) {
                const signals = [];
                
                const buyActive = data.cyclePos < 0.3 && data.fearGreed < 35 && data.fromATH < -30;
                signals.push({
                    icon: 'üü¢',
                    title: 'Smart Buy Zone',
                    status: buyActive ? 'ACTIVE - Accumulation Phase' : 'Not Active',
                    active: buyActive
                });
                
                let dcaStatus = 'Monitor';
                if (data.cyclePos < 0.4 && health > 60) dcaStatus = 'Aggressive (3x)';
                else if (data.cyclePos < 0.6) dcaStatus = 'Normal (1x)';
                else if (data.cyclePos < 0.8) dcaStatus = 'Conservative (0.5x)';
                else dcaStatus = 'Pause';
                
                signals.push({
                    icon: 'üîµ',
                    title: 'DCA Strategy',
                    status: dcaStatus,
                    active: dcaStatus !== 'Pause'
                });
                
                const holdActive = data.cyclePos >= 0.3 && data.cyclePos <= 0.7 && health > 40;
                signals.push({
                    icon: 'üü°',
                    title: 'Hold Position',
                    status: holdActive ? 'ACTIVE - Stable Phase' : 'Not Recommended',
                    active: holdActive
                });
                
                const exitActive = data.cyclePos > 0.8 || health < 30 || data.fearGreed > 85;
                signals.push({
                    icon: 'üî¥',
                    title: 'Exit Warning',
                    status: exitActive ? '‚ö†Ô∏è Consider Taking Profits' : 'Not Active',
                    active: exitActive,
                    warning: exitActive
                });
                
                return signals;
            }
        };

        function calculateCyclePosition(price) {
            const days = getDays(CONFIG.GENESIS_DATE);
            const support = 0.0000001 * Math.pow(days, 5.8);
            const resistance = 0.00001 * Math.pow(days, 5.8);
            const pos = (price - support) / (resistance - support);
            return Math.max(0, Math.min(1, safe(pos, 0.5)));
        }

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17, 22, 29, 0.95)',
                        titleColor: '#e6edf3',
                        bodyColor: '#9aa4af',
                        borderColor: 'rgba(59, 130, 246, 0.5)',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false
                    }
                }
            };

            charts.price = new Chart(document.getElementById('priceChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'BTC Price',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                            ticks: { color: '#6e7681', font: { size: 11 } }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false },
                            ticks: {
                                color: '#6e7681',
                                font: { size: 11 },
                                callback: v => '$' + v.toLocaleString()
                            }
                        }
                    }
                }
            });

            const gaugeOptions = {
                ...commonOptions,
                cutout: '75%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            };

            charts.health = new Chart(document.getElementById('healthGauge'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#22c55e', 'rgba(255, 255, 255, 0.05)'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: gaugeOptions
            });

            charts.cycle = new Chart(document.getElementById('cycleChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#3b82f6', 'rgba(255, 255, 255, 0.05)'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: gaugeOptions
            });

            charts.sentiment = new Chart(document.getElementById('sentimentChart'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#f59e0b', 'rgba(255, 255, 255, 0.05)'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: gaugeOptions
            });
        }

        async function updateDashboard() {
            console.log('üîÑ Updating...');
            
            try {
                const [btc, global, usdt, usdc, sentiment] = await Promise.all([
                    fetchJSON(CONFIG.API.bitcoin),
                    fetchJSON(CONFIG.API.global),
                    fetchJSON(CONFIG.API.usdt),
                    fetchJSON(CONFIG.API.usdc),
                    fetchJSON(CONFIG.API.fearGreed)
                ]);

                if (!btc?.market_data) return;

                const price = btc.market_data.current_price.usd;
                const change24h = btc.market_data.price_change_percentage_24h;
                const marketCap = btc.market_data.market_cap.usd;
                const volume = btc.market_data.total_volume.usd;
                const ath = btc.market_data.ath.usd;
                const supply = btc.market_data.circulating_supply;
                const dominance = global?.data?.market_cap_percentage?.btc || 50;
                
                const usdtCap = usdt?.market_data?.market_cap?.usd || 0;
                const usdcCap = usdc?.market_data?.market_cap?.usd || 0;
                const stablecoin = usdtCap + usdcCap;
                
                const fearGreed = sentiment?.data?.[0] ? parseInt(sentiment.data[0].value) : 50;
                const fearLabel = sentiment?.data?.[0]?.value_classification || 'Neutral';

                const cyclePos = calculateCyclePosition(price);
                const fromATH = ((price - ath) / ath) * 100;
                const daysHalving = getDays(CONFIG.HALVING_DATE);
                const topProb = Math.min(100, cyclePos * 100 + (daysHalving / 550) * 50);

                const data = {
                    price, change24h, marketCap, volume, ath, supply, dominance,
                    stablecoin, fearGreed, cyclePos, fromATH, daysHalving
                };

                const layers = LayerSystem.calculateAll(data);
                const health = LayerSystem.calculateMarketHealth(layers);
                const structure = MarketStructure.detectStructure(price, ath, cyclePos);
                const signals = SmartSignals.evaluate(data, layers, health);

                updateUI(data, layers, health, structure, signals, fearLabel, topProb);
                updateCharts(price, health, cyclePos, fearGreed);

                console.log('‚úÖ Updated');
            } catch (error) {
                console.error('‚ùå Error:', error);
            }
        }

        function updateUI(data, layers, health, structure, signals, fearLabel, topProb) {
            document.getElementById('topPrice').textContent = `$${fmt(data.price, 2)}`;
            const topChange = document.getElementById('topChange');
            topChange.textContent = fmtPercent(data.change24h);
            topChange.className = 'status-value ' + (data.change24h >= 0 ? 'bullish' : 'bearish');
            
            let regime = 'Accumulation';
            if (data.cyclePos > 0.7) regime = 'Distribution';
            else if (data.cyclePos > 0.4) regime = 'Markup';
            document.getElementById('topRegime').textContent = regime;
            
            const topHealth = document.getElementById('topHealth');
            const healthClass = health >= 75 ? 'excellent' : health >= 60 ? 'good' : 
                               health >= 40 ? 'fair' : 'poor';
            topHealth.className = `health-pill ${healthClass}`;
            topHealth.innerHTML = `<span class="pulse-dot"></span><span>Health: ${health}/100</span>`;

            document.getElementById('price').textContent = `$${fmt(data.price, 2)}`;
            document.getElementById('priceChange').textContent = fmtPercent(data.change24h);
            document.getElementById('mcap').textContent = fmtLarge(data.marketCap);
            document.getElementById('volume').textContent = fmtLarge(data.volume);
            document.getElementById('dominance').textContent = `${data.dominance.toFixed(2)}%`;
            document.getElementById('daysHalving').textContent = data.daysHalving;
            document.getElementById('fromATH').textContent = fmtPercent(data.fromATH);
            document.getElementById('cyclePos').textContent = data.cyclePos.toFixed(3);
            document.getElementById('topProb').textContent = `${Math.round(topProb)}%`;
            document.getElementById('fearValue').textContent = data.fearGreed;
            document.getElementById('fearLabel').textContent = fearLabel;
            document.getElementById('stablecoin').textContent = fmtLarge(data.stablecoin);
            document.getElementById('ath').textContent = `$${fmt(data.ath, 2)}`;
            document.getElementById('supply').textContent = `${fmt(data.supply, 0)} BTC`;
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('healthScore').textContent = health;
            const healthLabel = health >= 75 ? 'Excellent Conditions' :
                               health >= 60 ? 'Good Market Health' :
                               health >= 40 ? 'Fair - Monitor' : 'Poor - Caution';
            document.getElementById('healthLabel').textContent = healthLabel;
            
            const healthAlert = document.getElementById('healthAlert');
            if (health < 30) {
                healthAlert.innerHTML = `
                    <div class="alert danger">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <span class="alert-text">Market health is poor. High risk environment.</span>
                    </div>`;
            } else if (health > 85) {
                healthAlert.innerHTML = `
                    <div class="alert warning">
                        <span class="alert-icon">üî•</span>
                        <span class="alert-text">Market may be overheated. Monitor for correction.</span>
                    </div>`;
            } else {
                healthAlert.innerHTML = '';
            }

            updateLayers(layers);
            updateStructure(structure);
            updateSignals(signals);
        }

        function updateLayers(layers) {
            const container = document.getElementById('layersContainer');
            const layerData = [
                { name: 'Layer 1: Price Trend', score: layers.layer1, desc: 'EMA alignment & direction' },
                { name: 'Layer 2: Momentum', score: layers.layer2, desc: 'Short-term strength' },
                { name: 'Layer 3: Volatility', score: layers.layer3, desc: 'Market stability' },
                { name: 'Layer 4: Liquidity', score: layers.layer4, desc: 'Global liquidity' },
                { name: 'Layer 5: Sentiment', score: layers.layer5, desc: 'Fear & Greed' },
                { name: 'Layer 6: Structure', score: layers.layer6, desc: 'Support integrity' },
                { name: 'Layer 7: Cycle', score: layers.layer7, desc: 'Cycle position' }
            ];

            container.innerHTML = layerData.map(layer => {
                const scoreClass = layer.score >= 70 ? 'bullish' : layer.score >= 40 ? 'neutral' : 'bearish';
                const barColor = layer.score >= 70 ? '#22c55e' : layer.score >= 40 ? '#f59e0b' : '#ef4444';
                
                return `
                    <div class="layer">
                        <div class="layer-top">
                            <span class="layer-name">${layer.name}</span>
                            <span class="layer-score ${scoreClass}">${Math.round(layer.score)}</span>
                        </div>
                        <div class="layer-bar">
                            <div class="layer-fill" style="width: ${layer.score}%; background: ${barColor};"></div>
                        </div>
                        <div class="layer-desc">${layer.desc}</div>
                    </div>
                `;
            }).join('');
        }

        function updateStructure(structure) {
            const container = document.getElementById('structureList');
            container.innerHTML = structure.slice(0, 5).map(item => `
                <div class="structure-item">
                    <span class="structure-type">${item.type}</span>
                    <span class="structure-price">$${fmt(item.price, 0)}</span>
                    <span class="structure-badge ${item.strength.toLowerCase()}">${item.strength}</span>
                </div>
            `).join('');
        }

        function updateSignals(signals) {
            const container = document.getElementById('signalsContainer');
            container.innerHTML = signals.map(signal => {
                const activeClass = signal.active ? 'active' : '';
                const warningClass = signal.warning ? 'warning' : '';
                return `
                    <div class="signal ${activeClass} ${warningClass}">
                        <div class="signal-header">
                            <span class="signal-icon">${signal.icon}</span>
                            <div>
                                <div class="signal-title">${signal.title}</div>
                                <div class="signal-status">${signal.status}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateCharts(price, health, cyclePos, fearGreed) {
            const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            if (charts.price.data.labels.length > 20) {
                charts.price.data.labels.shift();
                charts.price.data.datasets[0].data.shift();
            }
            charts.price.data.labels.push(now);
            charts.price.data.datasets[0].data.push(price);
            charts.price.update('none');

            charts.health.data.datasets[0].data = [health, 100 - health];
            const healthColor = health >= 70 ? '#22c55e' : health >= 40 ? '#f59e0b' : '#ef4444';
            charts.health.data.datasets[0].backgroundColor[0] = healthColor;
            charts.health.update('none');

            charts.cycle.data.datasets[0].data = [cyclePos * 100, 100 - cyclePos * 100];
            charts.cycle.update('none');

            charts.sentiment.data.datasets[0].data = [fearGreed, 100 - fearGreed];
            const sentColor = fearGreed < 30 ? '#ef4444' : fearGreed < 50 ? '#f59e0b' : 
                             fearGreed < 70 ? '#3b82f6' : '#22c55e';
            charts.sentiment.data.datasets[0].backgroundColor[0] = sentColor;
            charts.sentiment.update('none');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Bitcoin Cycle Intelligence Initialized');
            initCharts();
            updateDashboard();
            setInterval(updateDashboard, CONFIG.UPDATE_INTERVAL);
        });
    </script>
</body>
</html>
